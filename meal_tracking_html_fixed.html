<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××¨×•×—×•×ª ×¢×•×‘×“×™×</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background: #34495e;
            justify-content: center;
        }
        
        .tab {
            padding: 15px 30px;
            background: #34495e;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            background: #3498db;
            border-bottom-color: #f39c12;
        }
        
        .tab:hover:not(.active) {
            background: #2c3e50;
        }
        
        .tab-content {
            display: none;
            padding: 40px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .employee-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .employee-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .employee-name {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .employee-id {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .barcode-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .barcode-container svg {
            background: white;
            padding: 10px;
            border-radius: 10px;
        }
        
        .scanner-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .scanner-input {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            text-align: center;
            border: 3px solid #3498db;
            border-radius: 10px;
        }
        
        .meal-record {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .meal-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .meal-employee {
            font-weight: 600;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .meal-date {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .admin-controls {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 30px;">
                <img src="https://via.placeholder.com/80x80/3498db/ffffff?text=LOGO" alt="×œ×•×’×•" style="height: 80px; border-radius: 10px;">
                <div>
                    <h1>ğŸ½ï¸ ××¢×¨×›×ª × ×™×”×•×œ ××¨×•×—×•×ª ×¢×•×‘×“×™×</h1>
                    <p>××¢×§×‘ ××—×¨ ×¦×¨×™×›×ª ××¨×•×—×•×ª ×‘×××¦×¢×•×ª ×‘×¨×§×•×“</p>
                </div>
                <img src="https://via.placeholder.com/80x80/3498db/ffffff?text=LOGO" alt="×œ×•×’×•" style="height: 80px; border-radius: 10px;">
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-tab="scanner">×¡×¨×™×§×ª ×‘×¨×§×•×“</button>
            <button class="tab" data-tab="employees" data-protected="true">× ×™×”×•×œ ×¢×•×‘×“×™×</button>
            <button class="tab" data-tab="reports" data-protected="true">×“×•×—×•×ª</button>
            <button class="tab" data-tab="admin" data-protected="true">× ×™×”×•×œ</button>
        </div>
        
        <!-- Password Modal -->
        <div id="passwordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px;">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">ğŸ”’ × ×“×¨×© ×§×•×“ ×’×™×©×”</h2>
                <p style="color: #7f8c8d; margin-bottom: 30px;">×”×–×Ÿ ×§×•×“ ×’×™×©×” ×©×œ 5 ×¡×¤×¨×•×ª</p>
                <input type="password" id="passwordInput" maxlength="5" style="width: 100%; padding: 15px; font-size: 24px; text-align: center; border: 3px solid #3498db; border-radius: 10px; letter-spacing: 10px; margin-bottom: 20px;" placeholder="â€¢â€¢â€¢â€¢â€¢">
                <div style="display: flex; gap: 10px;">
                    <button onclick="checkPassword()" class="btn" style="flex: 1;">××™×©×•×¨</button>
                    <button onclick="closePasswordModal()" class="btn btn-danger" style="flex: 1;">×‘×™×˜×•×œ</button>
                </div>
                <div id="passwordError" style="color: #e74c3c; margin-top: 15px; display: none;">âŒ ×§×•×“ ×’×™×©×” ×©×’×•×™</div>
            </div>
        </div>
        
        <!-- ×¡×¨×™×§×ª ×‘×¨×§×•×“ -->
        <div id="scanner" class="tab-content active">
            <div class="scanner-container">
                <h2>ğŸ” ×¡×¨×™×§×ª ×‘×¨×§×•×“ ×¢×•×‘×“</h2>
                <p>×¡×¨×•×§ ××ª ×”×‘×¨×§×•×“ ×©×œ ×”×¢×•×‘×“ ×‘×××¦×¢×•×ª ×”××¦×œ××” ××• ×”×§×œ×“ ××ª ×”××¡×¤×¨ ×™×“× ×™×ª</p>
                <br>
                
                <!-- ×›×¤×ª×•×¨ ×¡×¨×™×§×” ×‘××¦×œ××” -->
                <button class="btn" onclick="startCameraScan()" style="margin-bottom: 20px; background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                    ğŸ“· ×¡×¨×•×§ ×‘×¨×§×•×“ ×‘××¦×œ××”
                </button>
                
                <!-- ×•×™×“××• ×œ××¦×œ××” -->
                <div id="cameraContainer" style="display: none; margin-bottom: 20px;">
                    <video id="camera" width="100%" style="max-width: 500px; border-radius: 10px; border: 3px solid #3498db;"></video>
                    <br>
                    <button class="btn btn-danger" onclick="stopCameraScan()" style="margin-top: 10px;">×¡×’×•×¨ ××¦×œ××”</button>
                    <canvas id="canvas" style="display: none;"></canvas>
                </div>
                
                <input type="text" id="scannerInput" class="scanner-input" placeholder="××• ×”×§×œ×“ ××¡×¤×¨ ×¢×•×‘×“ ×™×“× ×™×ª...">
                <br><br>
                <button class="btn" onclick="processScan()">×¨×©×•× ××¨×•×—×”</button>
            </div>
            <div id="scanResult"></div>
        </div>
        
        <!-- × ×™×”×•×œ ×¢×•×‘×“×™× -->
        <div id="employees" class="tab-content">
            <div class="admin-controls">
                <h2>â• ×”×•×¡×£ ×¢×•×‘×“ ×—×“×©</h2>
                <div class="form-group">
                    <label for="employeeName">×©× ×”×¢×•×‘×“</label>
                    <input type="text" id="employeeName" placeholder="×”×›× ×¡ ×©× ××œ×">
                </div>
                <div class="form-group">
                    <label for="employeeId">××¡×¤×¨ ×¢×•×‘×“</label>
                    <input type="text" id="employeeId" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¢×•×‘×“ ×™×™×—×•×“×™">
                </div>
                <button class="btn" onclick="addEmployee()">×”×•×¡×£ ×¢×•×‘×“</button>
            </div>
            
            <div id="employeesList">
                <h2>ğŸ“‹ ×¨×©×™××ª ×¢×•×‘×“×™×</h2>
                <div id="employeesContainer"></div>
            </div>
        </div>
        
        <!-- ×“×•×—×•×ª -->
        <div id="reports" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMeals">0</div>
                    <div class="stat-label">×¡×”"×› ××¨×•×—×•×ª ×”×—×•×“×©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalEmployees">0</div>
                    <div class="stat-label">××¡×¤×¨ ×¢×•×‘×“×™×</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayMeals">0</div>
                    <div class="stat-label">××¨×•×—×•×ª ×”×™×•×</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgMeals">0</div>
                    <div class="stat-label">×××•×¦×¢ ××¨×•×—×•×ª ×œ×¢×•×‘×“</div>
                </div>
            </div>
            
            <div class="admin-controls">
                <h2>ğŸ” ×¡×™× ×•×Ÿ ×“×•×—×•×ª</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 20px; align-items: end;">
                    <div class="form-group">
                        <label for="filterEmployee">×‘×—×¨ ×¢×•×‘×“</label>
                        <select id="filterEmployee">
                            <option value="">×›×œ ×”×¢×•×‘×“×™×</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterMonth">×—×•×“×©</label>
                        <select id="filterMonth">
                            <option value="">×›×œ ×”×—×•×“×©×™×</option>
                        </select>
                    </div>
                    <button class="btn" onclick="filterReports()">×¡× ×Ÿ</button>
                </div>
            </div>
            
            <div id="mealsReport">
                <h2>ğŸ“Š ×¨×©×™××ª ××¨×•×—×•×ª</h2>
                <div id="mealsContainer"></div>
            </div>
        </div>
        
        <!-- × ×™×”×•×œ -->
        <div id="admin" class="tab-content">
            <div class="admin-controls">
                <h2>ğŸ”— ×”×’×“×¨×•×ª ×’×•×’×œ ×©×™×˜×¡</h2>
                <p>×”×–×Ÿ ××ª ×›×ª×•×‘×ª ×”-Web App ×©×œ ×’×•×’×œ ×©×™×˜×¡ ×›×“×™ ×œ×©×œ×•×— ××ª ×”× ×ª×•× ×™× ××•×˜×•××˜×™×ª</p>
                <br>
                <div class="form-group">
                    <label for="googleSheetsUrl">Google Sheets Web App URL</label>
                    <input type="text" id="googleSheetsUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                </div>
                <button class="btn" onclick="saveGoogleSheetsUrl()">×©××•×¨ ×”×’×“×¨×•×ª</button>
                <button class="btn" onclick="testGoogleSheets()">×‘×“×•×§ ×—×™×‘×•×¨</button>
                <div id="sheetsStatus"></div>
            </div>
            
            <div class="admin-controls">
                <h2>âš™ï¸ × ×™×”×•×œ ××¢×¨×›×ª</h2>
                <p>×¤×¢×•×œ×•×ª × ×™×”×•×œ ×œ×× ×”×œ×™× ×‘×œ×‘×“</p>
                <br>
                <button class="btn" onclick="exportData()">ğŸ“¥ ×™×™×¦× × ×ª×•× ×™×</button>
                <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ × ×§×” ××ª ×›×œ ×”× ×ª×•× ×™×</button>
            </div>
        </div>
    </div>

    <script>
        // × ×ª×•× ×™ ×”××¢×¨×›×ª
        let employees = loadData('employees') || [];
        let meals = loadData('meals') || [];
        
        // Google Sheets API - ×”×’×“×¨×•×ª
        let GOOGLE_SHEETS_URL = localStorage.getItem('googleSheetsUrl') || '';
        
        // ×”×’×“×¨×•×ª ××‘×˜×—×”
        const ACCESS_CODE = '05066';
        let isAuthenticated = false;
        let pendingTab = null;
        
        // ××©×ª× ×™× ×œ×¡×¨×™×§×ª ××¦×œ××”
        let cameraStream = null;
        let codeReader = null;
        
        // ×¤×•× ×§×¦×™×•×ª ×©××™×¨×” ×•×˜×¢×™× ×”
        function saveData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }
        
        function loadData(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error('Error loading data:', e);
                return null;
            }
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×©×œ×™×—×” ×œ×’×•×’×œ ×©×™×˜×¡
        async function sendToGoogleSheets(employee, date) {
            if (!GOOGLE_SHEETS_URL) {
                console.log('Google Sheets URL not configured');
                return false;
            }
            
            try {
                const data = {
                    employeeName: employee.name,
                    employeeId: employee.id,
                    date: new Date(date).toLocaleDateString('he-IL'),
                    time: new Date(date).toLocaleTimeString('he-IL'),
                    timestamp: date
                };
                
                await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                return true;
            } catch (error) {
                console.error('Error sending to Google Sheets:', error);
                return false;
            }
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×˜××‘×™× - FIXED!
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                const isProtected = this.getAttribute('data-protected') === 'true';
                
                // ×× ×”×˜××‘ ××•×’×Ÿ ×•×œ× ×××•××ª
                if (isProtected && !isAuthenticated) {
                    pendingTab = tabName;
                    showPasswordModal();
                    return;
                }
                
                // ×”×¡×¨×ª active ××›×œ ×”×˜××‘×™× ×•×”×ª×•×›×Ÿ
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // ×”×•×¡×¤×ª active ×œ×˜××‘ ×•×ª×•×›×Ÿ ×”× ×•×›×—×™×™×
                this.classList.add('active');
                document.getElementById(tabName).classList.add('active');
                
                // ×˜×¢×™× ×ª × ×ª×•× ×™× ×¨×œ×•×•× ×˜×™×™×
                if (tabName === 'employees') {
                    displayEmployees();
                } else if (tabName === 'reports') {
                    displayReports();
                    updateFilters();
                }
            });
        });
        
        // ×¤×•× ×§×¦×™×•×ª ××™××•×ª
        function showPasswordModal() {
            const modal = document.getElementById('passwordModal');
            modal.style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            setTimeout(() => {
                document.getElementById('passwordInput').focus();
            }, 100);
        }
        
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            pendingTab = null;
        }
        
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            
            if (input === ACCESS_CODE) {
                isAuthenticated = true;
                closePasswordModal();
                
                // ×¢×‘×•×¨ ×œ×˜××‘ ×”××‘×•×§×©
                if (pendingTab) {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    document.querySelector(`[data-tab="${pendingTab}"]`).classList.add('active');
                    document.getElementById(pendingTab).classList.add('active');
                    
                    if (pendingTab === 'employees') {
                        displayEmployees();
                    } else if (pendingTab === 'reports') {
                        displayReports();
                        updateFilters();
                    }
                    
                    pendingTab = null;
                }
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }
        
        // ××¤×©×¨ Enter ×‘××•×“×œ ×¡×™×¡××”
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
        
        // ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×¢×•×‘×“
        function addEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            const id = document.getElementById('employeeId').value.trim();
            
            if (!name || !id) {
                showMessage('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª', 'error', 'employees');
                return;
            }
            
            if (employees.find(emp => emp.id === id)) {
                showMessage('××¡×¤×¨ ×¢×•×‘×“ ×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª', 'error', 'employees');
                return;
            }
            
            employees.push({
                id: id,
                name: name,
                addedDate: new Date().toISOString()
            });
            
            saveData('employees', employees);
            
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeId').value = '';
            
            showMessage(`×”×¢×•×‘×“ ${name} × ×•×¡×£ ×‘×”×¦×œ×—×”!`, 'success', 'employees');
            displayEmployees();
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×¢×•×‘×“×™×
        function displayEmployees() {
            const container = document.getElementById('employeesContainer');
            
            if (employees.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #7f8c8d; background: #f8f9fa; border-radius: 15px;">××™×Ÿ ×¢×•×‘×“×™× ×‘××¢×¨×›×ª. ×”×•×¡×£ ×¢×•×‘×“ ×¨××©×•×Ÿ!</div>';
                return;
            }
            
            container.innerHTML = employees.map(employee => {
                const mealCount = meals.filter(meal => meal.employeeId === employee.id).length;
                return `
                    <div class="employee-card">
                        <div class="employee-info">
                            <div>
                                <div class="employee-name">${employee.name}</div>
                                <div class="employee-id">××¡×¤×¨ ×¢×•×‘×“: ${employee.id} | ${mealCount} ××¨×•×—×•×ª</div>
                            </div>
                            <button class="btn btn-danger" onclick="removeEmployee('${employee.id}')">×”×¡×¨</button>
                        </div>
                        <div class="barcode-container">
                            <svg id="barcode_${employee.id}"></svg>
                        </div>
                    </div>
                `;
            }).join('');
            
            // ×™×¦×™×¨×ª ×‘×¨×§×•×“×™×
            setTimeout(() => {
                employees.forEach(employee => {
                    try {
                        JsBarcode(`#barcode_${employee.id}`, employee.id, {
                            format: "CODE128",
                            width: 2,
                            height: 60,
                            displayValue: true,
                            fontSize: 16,
                            margin: 10
                        });
                    } catch (e) {
                        console.error('Error creating barcode:', e);
                    }
                });
            }, 100);
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×”×¡×¨×ª ×¢×•×‘×“
        function removeEmployee(employeeId) {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¡×™×¨ ××ª ×”×¢×•×‘×“?')) {
                employees = employees.filter(emp => emp.id !== employeeId);
                meals = meals.filter(meal => meal.employeeId !== employeeId);
                saveData('employees', employees);
                saveData('meals', meals);
                showMessage('×”×¢×•×‘×“ ×”×•×¡×¨ ×‘×”×¦×œ×—×”', 'success', 'employees');
                displayEmployees();
            }
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×¢×™×‘×•×“ ×¡×¨×™×§×”
        function processScan() {
            const scannedCode = document.getElementById('scannerInput').value.trim();
            
            if (!scannedCode) {
                showMessage('×× × ×¡×¨×•×§ ×‘×¨×§×•×“ ××• ×”×§×œ×“ ××¡×¤×¨ ×¢×•×‘×“', 'error', 'scanner');
                return;
            }
            
            const employee = employees.find(emp => emp.id === scannedCode);
            
            if (!employee) {
                showMessage('×¢×•×‘×“ ×œ× × ××¦× ×‘××¢×¨×›×ª', 'error', 'scanner');
                document.getElementById('scannerInput').value = '';
                return;
            }
            
            // ×‘×“×™×§×” ×× ×”×¢×•×‘×“ ×›×‘×¨ ××›×œ ×”×™×•×
            const today = new Date().toISOString().split('T')[0];
            const todayMeal = meals.find(meal => 
                meal.employeeId === employee.id && 
                meal.date.split('T')[0] === today
            );
            
            if (todayMeal) {
                showMessage(`${employee.name} ×›×‘×¨ ××›×œ ×”×™×•× ×‘×©×¢×” ${new Date(todayMeal.date).toLocaleTimeString('he-IL')}`, 'error', 'scanner');
                document.getElementById('scannerInput').value = '';
                return;
            }
            
            // ×¨×™×©×•× ××¨×•×—×”
            const meal = {
                id: Date.now().toString(),
                employeeId: employee.id,
                employeeName: employee.name,
                date: new Date().toISOString()
            };
            
            meals.push(meal);
            saveData('meals', meals);
            
            // ×©×œ×™×—×” ×œ×’×•×’×œ ×©×™×˜×¡
            sendToGoogleSheets(employee, meal.date);
            
            const resultDiv = document.getElementById('scanResult');
            resultDiv.innerHTML = `
                <div class="success-message">
                    <h3>âœ… ××¨×•×—×” × ×¨×©××” ×‘×”×¦×œ×—×”!</h3>
                    <p><strong>×©× ×”×¢×•×‘×“:</strong> ${employee.name}</p>
                    <p><strong>×ª××¨×™×š ×•×©×¢×”:</strong> ${new Date().toLocaleString('he-IL')}</p>
                    ${GOOGLE_SHEETS_URL ? '<p style="color: #28a745;">âœ“ × ×©×œ×— ×œ×’×•×’×œ ×©×™×˜×¡</p>' : ''}
                </div>
            `;
            
            document.getElementById('scannerInput').value = '';
            document.getElementById('scannerInput').focus();
        }
        
        // ×˜×™×¤×•×œ ×‘-Enter ×‘×¡×¨×™×§×”
        document.getElementById('scannerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processScan();
            }
        });
        
        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×“×•×—×•×ª
        function displayReports() {
            updateStats();
            displayMeals();
        }
        
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const todayMeals = meals.filter(meal => meal.date.split('T')[0] === today).length;
            const monthlyMeals = meals.filter(meal => {
                const mealDate = new Date(meal.date);
                return mealDate.getMonth() === currentMonth && mealDate.getFullYear() === currentYear;
            }).length;
            
            const avgMeals = employees.length > 0 ? Math.round(monthlyMeals / employees.length) : 0;
            
            document.getElementById('totalMeals').textContent = monthlyMeals;
            document.getElementById('totalEmployees').textContent = employees.length;
            document.getElementById('todayMeals').textContent = todayMeals;
            document.getElementById('avgMeals').textContent = avgMeals;
        }
        
        // ×”×¦×’×ª ××¨×•×—×•×ª
        function displayMeals() {
            const container = document.getElementById('mealsContainer');
            
            if (meals.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #7f8c8d; background: #f8f9fa; border-radius: 15px;">××™×Ÿ ×¨×™×©×•××™ ××¨×•×—×•×ª ×¢×“×™×™×Ÿ</div>';
                return;
            }
            
            const sortedMeals = [...meals].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedMeals.map(meal => `
                <div class="meal-record">
                    <div class="meal-info">
                        <div>
                            <div class="meal-employee">${meal.employeeName}</div>
                            <div class="meal-date">${new Date(meal.date).toLocaleString('he-IL')}</div>
                        </div>
                        <button class="btn btn-danger" onclick="removeMeal('${meal.id}')">×”×¡×¨</button>
                    </div>
                </div>
            `).join('');
        }
        
        // ×¢×“×›×•×Ÿ ×¤×™×œ×˜×¨×™×
        function updateFilters() {
            const employeeFilter = document.getElementById('filterEmployee');
            const monthFilter = document.getElementById('filterMonth');
            
            employeeFilter.innerHTML = '<option value="">×›×œ ×”×¢×•×‘×“×™×</option>' +
                employees.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
            
            const months = [...new Set(meals.map(meal => {
                const date = new Date(meal.date);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }))].sort().reverse();
            
            monthFilter.innerHTML = '<option value="">×›×œ ×”×—×•×“×©×™×</option>' +
                months.map(month => {
                    const [year, monthNum] = month.split('-');
                    const monthName = new Date(year, monthNum - 1).toLocaleDateString('he-IL', { month: 'long', year: 'numeric' });
                    return `<option value="${month}">${monthName}</option>`;
                }).join('');
        }
        
        // ×¡×™× ×•×Ÿ ×“×•×—×•×ª
        function filterReports() {
            const employeeId = document.getElementById('filterEmployee').value;
            const month = document.getElementById('filterMonth').value;
            
            let filteredMeals = meals;
            
            if (employeeId) {
                filteredMeals = filteredMeals.filter(meal => meal.employeeId === employeeId);
            }
            
            if (month) {
                filteredMeals = filteredMeals.filter(meal => {
                    const mealDate = new Date(meal.date);
                    const mealMonth = `${mealDate.getFullYear()}-${String(mealDate.getMonth() + 1).padStart(2, '0')}`;
                    return mealMonth === month;
                });
            }
            
            displayFilteredMeals(filteredMeals);
        }
        
        // ×”×¦×’×ª ××¨×•×—×•×ª ××¡×•× × ×•×ª
        function displayFilteredMeals(filteredMeals) {
            const container = document.getElementById('mealsContainer');
            
            if (filteredMeals.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #7f8c8d; background: #f8f9fa; border-radius: 15px;">×œ× × ××¦××• ××¨×•×—×•×ª ×œ×¤×™ ×”×¡×™× ×•×Ÿ ×©× ×‘×—×¨</div>';
                return;
            }
            
            const sortedMeals = [...filteredMeals].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedMeals.map(meal => `
                <div class="meal-record">
                    <div class="meal-info">
                        <div>
                            <div class="meal-employee">${meal.employeeName}</div>
                            <div class="meal-date">${new Date(meal.date).toLocaleString('he-IL')}</div>
                        </div>
                        <button class="btn btn-danger" onclick="removeMeal('${meal.id}')">×”×¡×¨</button>
                    </div>
                </div>
            `).join('');
        }
        
        // ×”×¡×¨×ª ××¨×•×—×”
        function removeMeal(mealId) {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¡×™×¨ ××ª ×¨×™×©×•× ×”××¨×•×—×”?')) {
                meals = meals.filter(meal => meal.id !== mealId);
                saveData('meals', meals);
                showMessage('×¨×™×©×•× ×”××¨×•×—×” ×”×•×¡×¨ ×‘×”×¦×œ×—×”', 'success', 'reports');
                displayReports();
            }
        }
        
        // ×™×™×¦×•× × ×ª×•× ×™×
        function exportData() {
            const data = {
                employees: employees,
                meals: meals,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `meal_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }
        
        // × ×™×§×•×™ × ×ª×•× ×™×
        function clearAllData() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×?')) {
                employees = [];
                meals = [];
                saveData('employees', employees);
                saveData('meals', meals);
                showMessage('×”× ×ª×•× ×™× × ×•×§×• ×‘×”×¦×œ×—×”', 'success', 'admin');
                displayEmployees();
                displayReports();
            }
        }
        
        // ×”×¦×’×ª ×”×•×“×¢×•×ª
        function showMessage(text, type, tabId) {
            const tab = document.getElementById(tabId);
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = text;
            
            tab.insertBefore(messageDiv, tab.firstChild);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }
        
        // ××ª×—×•×œ
        document.getElementById('scannerInput').focus();
        
        // ×˜×¢×™× ×ª Google Sheets URL
        if (GOOGLE_SHEETS_URL) {
            const urlInput = document.getElementById('googleSheetsUrl');
            if (urlInput) {
                urlInput.value = GOOGLE_SHEETS_URL;
            }
        }
        
        // ×¤×•× ×§×¦×™×•×ª Google Sheets
        function saveGoogleSheetsUrl() {
            const url = document.getElementById('googleSheetsUrl').value.trim();
            if (url) {
                localStorage.setItem('googleSheetsUrl', url);
                GOOGLE_SHEETS_URL = url;
                showMessage('×›×ª×•×‘×ª Google Sheets × ×©××¨×” ×‘×”×¦×œ×—×”!', 'success', 'admin');
            } else {
                showMessage('×× × ×”×–×Ÿ ×›×ª×•×‘×ª ×ª×§×™× ×”', 'error', 'admin');
            }
        }
        
        async function testGoogleSheets() {
            if (!GOOGLE_SHEETS_URL) {
                showMessage('×× × ×”×–×Ÿ ×›×ª×•×‘×ª Google Sheets ×ª×—×™×œ×”', 'error', 'admin');
                return;
            }
            
            const statusDiv = document.getElementById('sheetsStatus');
            statusDiv.innerHTML = '<p style="color: #3498db;">×‘×•×“×§ ×—×™×‘×•×¨...</p>';
            
            try {
                await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test: true,
                        employeeName: '×‘×“×™×§×”',
                        employeeId: 'TEST',
                        date: new Date().toLocaleDateString('he-IL'),
                        time: new Date().toLocaleTimeString('he-IL')
                    })
                });
                
                statusDiv.innerHTML = '<p style="color: #28a745;">âœ“ ×”×‘×“×™×§×” × ×©×œ×—×”! ×‘×“×•×§ ××ª Google Sheets ×©×œ×š</p>';
            } catch (error) {
                statusDiv.innerHTML = '<p style="color: #e74c3c;">âœ— ×©×’×™××” ×‘×©×œ×™×—×”. ×‘×“×•×§ ××ª ×”×›×ª×•×‘×ª</p>';
            }
        }
        
        // ×¤×•× ×§×¦×™×•×ª ×¡×¨×™×§×ª ×‘×¨×§×•×“ ×‘××¦×œ××”
        async function startCameraScan() {
            try {
                const cameraContainer = document.getElementById('cameraContainer');
                const video = document.getElementById('camera');
                
                // ×‘×§×© ×’×™×©×” ×œ××¦×œ××”
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // ××¦×œ××” ××—×•×¨×™×ª ×‘××•×‘×™×™×œ
                });
                
                video.srcObject = cameraStream;
                video.play();
                cameraContainer.style.display = 'block';
                
                // ××ª×—×•×œ ×¡×•×¨×§ ×‘×¨×§×•×“
                codeReader = new ZXing.BrowserMultiFormatReader();
                
                // ×”×ª×—×œ ×¡×¨×™×§×” ×¨×¦×™×¤×”
                codeReader.decodeFromVideoDevice(null, 'camera', (result, err) => {
                    if (result) {
                        // × ××¦× ×‘×¨×§×•×“!
                        const code = result.text;
                        document.getElementById('scannerInput').value = code;
                        
                        // ×¢×¦×•×¨ ×¡×¨×™×§×” ×•×¢×‘×“
                        stopCameraScan();
                        processScan();
                    }
                });
                
            } catch (error) {
                console.error('Camera error:', error);
                alert('×œ× ×”×¦×œ×—× ×• ×œ×’×©×ª ×œ××¦×œ××”. ×× × ×•×•×“× ×©× ×ª×ª ×”×¨×©××•×ª ×œ××¦×œ××” ×‘×“×¤×“×¤×Ÿ.');
            }
        }
        
        function stopCameraScan() {
            const cameraContainer = document.getElementById('cameraContainer');
            const video = document.getElementById('camera');
            
            // ×¢×¦×•×¨ ××ª ×”××¦×œ××”
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // ×¢×¦×•×¨ ××ª ×”×¡×•×¨×§
            if (codeReader) {
                codeReader.reset();
                codeReader = null;
            }
            
            video.srcObject = null;
            cameraContainer.style.display = 'none';
        }
    </script>
</body>
</html>